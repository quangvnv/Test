<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section 2: Listen and choose the best answer</title>
    
    <style>
        /* RESET & BASE - Cloned from Section2.html */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100vh; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; }
        body { display: flex; flex-direction: column; }

        /* ===== TOP BAR (Cloned exactly from Section2.html) ===== */
        .top-bar {
            flex-shrink: 0; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 1000; padding: 10px 20px; border-bottom: 1px solid #eee;
        }
        .header {
            display: grid; grid-template-columns: 120px 1fr 120px; align-items: center;
            max-width: 1400px; margin: 0 auto;
        }
        .header h1 {
            grid-column: 2; font-size: 20px; color: #333; text-align: center;
            margin: 0; font-weight: 600;
        }
        .font-controls {
            grid-column: 3; display: flex; gap: 8px; justify-content: flex-end;
        }
        .font-controls button {
            padding: 6px 12px; background: #2196F3; color: #333; /* Section2 original uses color #333 on blue btn */
            border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.2s;
        }
        .font-controls button:hover { background: #e9ecef; border-color: #ccc; }
        .navigation {
            display: flex; gap: 8px; margin-top: 10px; justify-content: center;
        }
        .nav-btn {
            padding: 5px 15px; border: 1px solid #2196F3; background: white;
            color: #2196F3; border-radius: 4px; cursor: pointer;
        }
        .nav-btn.active { background: #2196F3; color: white; }

        /* Listening specific: Audio section added into top bar flow */
        .audio-section { margin-top: 8px; display: flex; justify-content: center; }
        .audio-player { width: 100%; max-width: 500px; }
        .audio-player audio { width: 100%; height: 35px; }

        /* ===== MAIN LAYOUT (Cloned from Section2.html) ===== */
        .main-layout {
            flex: 1; display: flex; overflow: hidden; padding: 20px; gap: 20px;
            max-width: 1400px; width: 100%; margin: 0 auto;
        }

        /* LEFT PANEL: QUIZ NAVIGATION (Cloned from Section2.html) */
        .quiz-nav-panel {
            flex-shrink: 0; width: 250px; background: white; border-radius: 8px;
            border: 2px solid #e0e0e0; display: flex; flex-direction: column; overflow: hidden;
        }
        .quiz-nav-header {
            padding: 15px; background: #f8f9fa; color: #333; font-weight: bold;
            text-align: center; border-bottom: 1px solid #eee;
        }
        .quiz-nav-grid {
            flex: 1; overflow-y: auto; padding: 15px; display: grid;
            grid-template-columns: repeat(4, 1fr); gap: 10px; align-content: start;
        }
        .quiz-nav-btn {
            aspect-ratio: 1; border: 1px solid #ddd; background: white;
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px;
        }
        .quiz-nav-btn.answered { background: #4CAF50; color: white; border-color: #555; }
        .quiz-nav-btn.current { border: 2px solid #FF9800; }
        .quiz-nav-legend { padding: 10px; border-top: 1px solid #eee; font-size: 11px; }
        .legend-item { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
        .legend-box { width: 12px; height: 12px; border: 1px solid #ddd; border-radius: 2px; }

        /* RIGHT PANEL: CONTENT AREA (Adjusted for Independent Scroll) */
        .content-area { flex: 1; display: flex; gap: 20px; overflow: hidden; }
        
        .questions-wrapper, .tapescript-panel {
            flex: 1; background: white; border-radius: 8px; border: 2px solid #e0e0e0;
            overflow-y: auto; padding: 30px; scroll-behavior: smooth;
        }
        .tapescript-panel { display: none; border-left: 4px solid #4CAF50; }
        .tapescript-panel.show { display: block; }

        .question-item { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #eee; scroll-margin-top: 20px; }
        .question-text { font-weight: 600; margin-bottom: 15px; font-size: 18px; color: #2c3e50; }
        .options-container { display: flex; flex-direction: column; gap: 10px; }
        .option-item {
            display: flex; align-items: center; padding: 12px 15px; border: 1px solid #e0e0e0;
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .option-item:hover { background-color: #f9f9f9; }
        .option-item.selected { background: #e3f2fd; border-color: #2196F3; }
        .option-item.correct { background: #d4edda; border-color: #28a745; color: #155724; }
        .option-item.incorrect { background: #f8d7da; border-color: #dc3545; color: #721c24; }

        /* ===== BOTTOM BAR (Cloned from Section2.html) ===== */
        .bottom-bar {
            flex-shrink: 0; background: white; padding: 10px; display: flex;
            justify-content: center; gap: 15px; border-top: 1px solid #ddd;
        }
        .btn { padding: 10px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .submit-btn { background: #2196F3; }
        .submit-btn:hover { background: #1976D2; }
        .retry-btn { background: #FF9800; display: none; }
        .top-btn { background: #4caf50; }

        /* MODAL (Cloned from Section2.html) */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 400px; width: 90%; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="header">
            <div></div>
            <h1>Section 2: Listen and choose the best answer</h1>
            <div class="font-controls">
                <button onclick="changeFontSize(1)">A+</button>
                <button onclick="changeFontSize(-1)">A‚àí</button>
            </div>
        </div>
        <div class="navigation" id="navigation"></div>
        <div class="audio-section">
            <div class="audio-player">
                <audio controls id="audioPlayer"><source src="" type="audio/mpeg" id="audioSource"></audio>
            </div>
        </div>
    </div>

    <div class="main-layout">
        <div class="quiz-nav-panel">
            <div class="quiz-nav-header">Quiz navigation</div>
            <div class="quiz-nav-grid" id="quizNavGrid"></div>
            <div class="quiz-nav-legend">
                <div class="legend-item"><div class="legend-box"></div> Ch∆∞a tr·∫£ l·ªùi</div>
                <div class="legend-item"><div class="legend-box" style="background: #4CAF50;"></div> ƒê√£ tr·∫£ l·ªùi</div>
                <div class="legend-item"><div class="legend-box" style="border: 2px solid #FF9800;"></div> ƒêang xem</div>
            </div>
        </div>

        <div class="content-area">
            <div class="questions-wrapper" id="scrollArea">
                <div id="sectionsContainer"></div>
            </div>
            <div class="tapescript-panel" id="tapescriptPanel">
                <h3 style="color:#2E7D32; margin-bottom:15px; border-bottom: 2px solid #4CAF50; display:inline-block;">üìù Tapescript</h3>
                <div id="tapescriptContent" style="line-height:1.8; white-space:pre-wrap; color: #444;"></div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn submit-btn" id="submitBtn">N·ªôp b√†i</button>
        <button class="btn retry-btn" id="retryBtn">L√†m l·∫°i</button>
        <button class="btn top-btn" onclick="scrollToTop()">V·ªÅ ƒë·∫ßu trang</button>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <div id="resultEmoji" style="font-size: 50px;">üéâ</div>
            <h2 id="resultMessage">K·∫øt qu·∫£</h2>
            <div id="resultScore" style="font-size: 40px; color: #2196F3; font-weight: bold; margin: 10px 0;">0/0</div>
            <p id="resultPercentage">T·ª∑ l·ªá ch√≠nh x√°c: 0%</p>
            <button class="btn submit-btn" style="margin-top: 20px; width: 100%;" onclick="showTapescript()">Xem Tapescript</button>
        </div>
    </div>

    <script>
        let allSections = [];
        let currentSectionIndex = 0;
        let userAnswers = {};
        let fontSize = 18;
        let isSubmitted = false;

        async function loadQuestions() {
            try {
                const response = await fetch('listening-s2-questions.json');
                allSections = await response.json();
                renderNavigation();
                renderSection(0);
            } catch (e) { console.error("Load error:", e); }
        }

        function renderNavigation() {
            const navDiv = document.getElementById('navigation');
            navDiv.innerHTML = allSections.map((_, idx) => `
                <button class="nav-btn ${idx === 0 ? 'active' : ''}" onclick="switchSection(${idx})">Test ${idx + 1}</button>
            `).join('');
        }

        function switchSection(index) {
            currentSectionIndex = index;
            isSubmitted = false;
            renderSection(index);
            document.querySelectorAll('.nav-btn').forEach((btn, idx) => btn.classList.toggle('active', idx === index));
        }

        function renderSection(idx) {
            const section = allSections[idx];
            userAnswers = {};
            document.getElementById('audioSource').src = section.audio;
            document.getElementById('audioPlayer').load();
            document.getElementById('tapescriptContent').textContent = section.tapescript || "B·∫£n g·ª° bƒÉng ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t...";

            const container = document.getElementById('sectionsContainer');
            const navGrid = document.getElementById('quizNavGrid');
            container.innerHTML = ''; navGrid.innerHTML = '';

            section.questions.forEach((q, qIdx) => {
                const navBtn = document.createElement('button');
                navBtn.className = 'quiz-nav-btn';
                navBtn.id = `nav-btn-${qIdx}`;
                navBtn.textContent = qIdx + 1;
                navBtn.onclick = () => document.getElementById(`q-item-${qIdx}`).scrollIntoView({behavior: 'smooth'});
                navGrid.appendChild(navBtn);

                const qDiv = document.createElement('div');
                qDiv.className = 'question-item';
                qDiv.id = `q-item-${qIdx}`;
                qDiv.innerHTML = `
                    <div class="question-text" style="font-size:${fontSize}px">${qIdx + 1}. ${q.question}</div>
                    <div class="options-container">
                        ${q.options.map((opt, oIdx) => `
                            <label class="option-item" id="option-${idx}-${qIdx}-${oIdx}" style="font-size:${fontSize-2}px">
                                <input type="radio" name="q-${qIdx}" style="margin-right:12px; transform:scale(1.2)" onchange="handleAnswer(${qIdx}, ${oIdx})">
                                <span>${String.fromCharCode(65 + oIdx)}. ${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                container.appendChild(qDiv);
            });
            document.getElementById('tapescriptPanel').classList.remove('show');
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('retryBtn').style.display = 'none';
        }

        function handleAnswer(qIdx, oIdx) {
            if (isSubmitted) return;
            userAnswers[qIdx] = oIdx;
            document.getElementById(`nav-btn-${qIdx}`).classList.add('answered');
            document.querySelectorAll(`#q-item-${qIdx} .option-item`).forEach((el, idx) => {
                el.classList.toggle('selected', idx === oIdx);
            });
        }

        document.getElementById('submitBtn').onclick = () => {
            isSubmitted = true;
            const section = allSections[currentSectionIndex];
            let score = 0;
            section.questions.forEach((q, qIdx) => {
                const userAns = userAnswers[qIdx];
                if (userAns === q.answer) score++;
                q.options.forEach((_, oIdx) => {
                    const el = document.getElementById(`option-${currentSectionIndex}-${qIdx}-${oIdx}`);
                    el.querySelector('input').disabled = true;
                    if (oIdx === q.answer) el.classList.add('correct');
                    else if (oIdx === userAns) el.classList.add('incorrect');
                });
            });
            document.getElementById('resultScore').textContent = `${score}/${section.questions.length}`;
            document.getElementById('resultPercentage').textContent = `T·ª∑ l·ªá: ${Math.round(score/section.questions.length*100)}%`;
            document.getElementById('resultModal').classList.add('show');
        };

        function showTapescript() {
            document.getElementById('resultModal').classList.remove('show');
            document.getElementById('tapescriptPanel').classList.add('show');
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('retryBtn').style.display = 'inline-block';
        }

        function scrollToTop() { document.getElementById('scrollArea').scrollTo({top:0, behavior:'smooth'}); }
        function changeFontSize(delta) {
            fontSize += delta;
            document.querySelectorAll('.question-text').forEach(el => el.style.fontSize = fontSize + 'px');
            document.querySelectorAll('.option-item').forEach(el => el.style.fontSize = (fontSize - 2) + 'px');
        }

        document.getElementById('retryBtn').onclick = () => renderSection(currentSectionIndex);

        document.getElementById('scrollArea').addEventListener('scroll', () => {
            document.querySelectorAll('.question-item').forEach((item, idx) => {
                const rect = item.getBoundingClientRect();
                if (rect.top >= 0 && rect.top <= 300) {
                    document.querySelectorAll('.quiz-nav-btn').forEach(b => b.classList.remove('current'));
                    document.getElementById(`nav-btn-${idx}`).classList.add('current');
                }
            });
        });

        window.onload = loadQuestions;
    </script>
</body>
</html>