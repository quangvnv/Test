<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section 3: Listen and Fill in the Blanks</title>
    
    <style>
        /* ==========================================================
           CLONE TOPBAR, BOTTOM BAR, NAV TỪ SECTION 2 (GIỮ NGUYÊN STYLE)
           ========================================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100vh; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; }
        body { display: flex; flex-direction: column; }

        .top-bar {
            flex-shrink: 0; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 1000; padding: 10px 20px; border-bottom: 1px solid #eee;
        }
        .header {
            display: grid; grid-template-columns: 120px 1fr 120px; align-items: center;
            max-width: 1400px; margin: 0 auto;
        }
        .header h1 { grid-column: 2; font-size: 20px; color: #333; text-align: center; margin: 0; font-weight: 600; }
        .font-controls { grid-column: 3; display: flex; gap: 8px; justify-content: flex-end; }
        .font-controls button { padding: 6px 12px; background: #2196F3; color: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .navigation { display: flex; gap: 8px; margin-top: 10px; justify-content: center; }
        .nav-btn { padding: 5px 15px; border: 1px solid #2196F3; background: white; color: #2196F3; border-radius: 4px; cursor: pointer; }
        .nav-btn.active { background: #2196F3; color: white; }

        .audio-section { margin-top: 8px; display: flex; justify-content: center; }
        .audio-player { width: 100%; max-width: 500px; }
        .audio-player audio { width: 100%; height: 35px; }

        .main-layout {
            flex: 1; display: flex; overflow: hidden; padding: 20px; gap: 20px;
            max-width: 1400px; width: 100%; margin: 0 auto;
        }

        /* QUIZ NAV PANEL (CLONE SECTION 2) */
        .quiz-nav-panel {
            flex-shrink: 0; width: 250px; background: white; border-radius: 8px;
            border: 2px solid #e0e0e0; display: flex; flex-direction: column; overflow: hidden;
        }
        .quiz-nav-header { padding: 15px; background: #f8f9fa; font-weight: bold; text-align: center; border-bottom: 1px solid #eee; }
        .quiz-nav-grid { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; align-content: start; }
        .quiz-nav-btn { aspect-ratio: 1; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .quiz-nav-btn.answered { background: #4CAF50 !color: white; border-color: #4CAF50; color: white;}
        .quiz-nav-btn.current { border: 2px solid #FF9800; }
        .quiz-nav-legend { padding: 10px; border-top: 1px solid #eee; font-size: 11px; }

        /* CONTENT AREA */
        .questions-wrapper {
            flex: 1; background: white; border-radius: 8px; border: 2px solid #e0e0e0;
            overflow-y: auto; padding: 40px; scroll-behavior: smooth;
        }

        /* BOTTOM BAR (CLONE SECTION 2) */
        .bottom-bar {
            flex-shrink: 0; background: white; padding: 10px; display: flex;
            justify-content: center; gap: 15px; border-top: 1px solid #ddd;
        }
        .btn { padding: 10px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .submit-btn { background: #2196F3; }
        .retry-btn { background: #FF9800; display: none; }
        .top-btn { background: #4caf50; }

        /* ==========================================================
           GIỮ NGUYÊN CÁCH HIỂN THỊ ĐÁP ÁN GỐC CỦA SECTION 3
           ========================================================== */
        .passage-content { line-height: 2.5; color: #333; }
        .blank-container { display: inline-block; position: relative; margin: 0 5px; }
        .blank-input {
            border: none; border-bottom: 2px solid #2196F3; background: #f0f7ff;
            padding: 2px 8px; text-align: center; font-weight: 600; color: #1976D2;
            width: 140px; outline: none; transition: 0.3s;
        }
        .blank-input.correct { border-bottom-color: #4CAF50; background: #e8f5e9; color: #2e7d32; }
        .blank-input.incorrect { border-bottom-color: #f44336; background: #ffebee; color: #c62828; }
        
        /* Hint hiện phía trên ô input (Giữ nguyên từ code đầu tiên bạn gửi) */
        .correct-answer-hint {
            display: none; position: absolute; top: -28px; left: 0;
            background: #4CAF50; color: white; font-size: 13px;
            padding: 2px 8px; border-radius: 4px; white-space: nowrap; z-index: 10;
        }

        /* Modal Score */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 400px; width: 90%; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="header">
            <div></div>
            <h1>Section 3: Listen and Fill in the Blanks</h1>
            <div class="font-controls">
                <button onclick="changeFontSize(2)">A+</button>
                <button onclick="changeFontSize(-2)">A−</button>
            </div>
        </div>
        <div class="navigation" id="navigation"></div>
        <div class="audio-section">
            <div class="audio-player">
                <audio controls id="audioPlayer"><source src="" type="audio/mpeg" id="audioSource"></audio>
            </div>
        </div>
    </div>

    <div class="main-layout">
        <div class="quiz-nav-panel">
            <div class="quiz-nav-header">Quiz navigation</div>
            <div class="quiz-nav-grid" id="quizNavGrid"></div>
            <div class="quiz-nav-legend">
                <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;"><div style="width:12px; height:12px; border:1px solid #ddd;"></div> Chưa điền</div>
                <div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; background:#4CAF50;"></div> Đã điền</div>
            </div>
        </div>

        <div class="questions-wrapper" id="scrollArea">
            <div id="loading" style="text-align:center; padding: 20px;">Đang tải dữ liệu...</div>
            <div id="passageContainer" class="passage-content"></div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn submit-btn" id="submitBtn">Nộp bài</button>
        <button class="btn retry-btn" id="retryBtn">Làm lại</button>
        <button class="btn top-btn" onclick="scrollToTop()">Về đầu trang</button>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2 id="resultScore" style="font-size: 40px; color: #2196F3; margin-bottom: 10px;">0/0</h2>
            <p id="resultPercentage" style="font-weight: bold;">Chính xác: 0%</p>
            <button class="btn submit-btn" style="margin-top: 20px; width: 100%;" onclick="closeModal()">Xem đáp án</button>
        </div>
    </div>

    <script>
        let allSections = [];
        let currentSectionIndex = 0;
        let fontSize = 18;
        let isSubmitted = false;

        async function loadData() {
            try {
                const response = await fetch('listening-s3-questions.json');
                allSections = await response.json();
                document.getElementById('loading').style.display = 'none';
                renderNavigation();
                renderSection(0);
            } catch (e) { console.error("Lỗi tải file:", e); }
        }

        function renderNavigation() {
            const nav = document.getElementById('navigation');
            nav.innerHTML = allSections.map((_, idx) => `
                <button class="nav-btn ${idx === 0 ? 'active' : ''}" onclick="switchSection(${idx})">Test ${idx + 1}</button>
            `).join('');
        }

        function switchSection(idx) {
            currentSectionIndex = idx;
            isSubmitted = false;
            renderSection(idx);
            document.querySelectorAll('.nav-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
        }

        function renderSection(idx) {
            const section = allSections[idx];
            document.getElementById('audioSource').src = section.audio;
            document.getElementById('audioPlayer').load();

            const container = document.getElementById('passageContainer');
            const navGrid = document.getElementById('quizNavGrid');
            navGrid.innerHTML = '';

            let html = section.passage;
            section.blanks.forEach((blankStr, bIdx) => {
                const dotIndex = blankStr.indexOf('.');
                const answer = blankStr.substring(dotIndex + 1).trim();

                const inputHtml = `
                    <span class="blank-container">
                        <span class="correct-answer-hint" id="hint-${bIdx}">${answer}</span>
                        <input type="text" class="blank-input" id="input-${bIdx}" 
                               oninput="updateNavStatus(${bIdx})" placeholder="(${bIdx + 1})">
                    </span>
                `;
                
                // Regex tìm đúng text gốc (1) ...... để thay thế
                const pattern = new RegExp(`\\(${bIdx + 1}\\) \\.{5,}`, 'g');
                html = html.replace(pattern, inputHtml);

                // Nav button
                const btn = document.createElement('button');
                btn.className = 'quiz-nav-btn';
                btn.id = `nav-btn-${bIdx}`;
                btn.textContent = bIdx + 1;
                btn.onclick = () => {
                    const el = document.getElementById(`input-${bIdx}`);
                    el.focus();
                    el.scrollIntoView({behavior:'smooth', block:'center'});
                };
                navGrid.appendChild(btn);
            });

            container.innerHTML = html;
            document.getElementById('submitBtn').style.display = 'block';
            document.getElementById('retryBtn').style.display = 'none';
            applyFontSize();
        }

        function updateNavStatus(idx) {
            const val = document.getElementById(`input-${idx}`).value.trim();
            document.getElementById(`nav-btn-${idx}`).classList.toggle('answered', val !== "");
        }

        document.getElementById('submitBtn').onclick = () => {
            isSubmitted = true;
            const section = allSections[currentSectionIndex];
            let score = 0;

            section.blanks.forEach((blankStr, idx) => {
                const dotIndex = blankStr.indexOf('.');
                const correctVal = blankStr.substring(dotIndex + 1).trim().toLowerCase();
                const input = document.getElementById(`input-${idx}`);
                const userVal = input.value.trim().toLowerCase();

                input.disabled = true;
                if (userVal === correctVal) {
                    score++;
                    input.classList.add('correct');
                } else {
                    input.classList.add('incorrect');
                    document.getElementById(`hint-${idx}`).style.display = 'block';
                }
            });

            document.getElementById('resultScore').textContent = `${score}/${section.blanks.length}`;
            document.getElementById('resultPercentage').textContent = `Chính xác: ${Math.round(score/section.blanks.length*100)}%`;
            document.getElementById('resultModal').classList.add('show');
        };

        function closeModal() {
            document.getElementById('resultModal').classList.remove('show');
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('retryBtn').style.display = 'block';
        }

        function scrollToTop() { document.getElementById('scrollArea').scrollTo({top: 0, behavior: 'smooth'}); }
        function changeFontSize(delta) { fontSize += delta; applyFontSize(); }
        function applyFontSize() {
            const container = document.getElementById('passageContainer');
            if(container) container.style.fontSize = fontSize + 'px';
            document.querySelectorAll('.blank-input').forEach(i => i.style.fontSize = (fontSize-2) + 'px');
        }

        document.getElementById('retryBtn').onclick = () => switchSection(currentSectionIndex);
        window.onload = loadData;
    </script>
</body>
</html>