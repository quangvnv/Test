<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section 1: Audio Listening Test</title>
    
    <style>
        /* RESET & BASE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100vh;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        /* ===== TOP BAR ===== */
        .top-bar {
            flex-shrink: 0;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 10px 20px;
            border-bottom: 5px solid #2196F3;
        }

        .header {
            display: grid;
            grid-template-columns: 120px 1fr 120px;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header h1 {
            grid-column: 2;
            font-size: 20px;
            color: #333;
            text-align: center;
            margin: 0;
            font-weight: 600;
        }

        .font-controls {
            grid-column: 3;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .font-controls button {
            padding: 6px 12px;
            background: #2196F3;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .font-controls button:hover {
            background: #e9ecef;
            border-color: #ccc;
        }

        .navigation {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
        }

        .nav-btn {
            padding: 5px 15px;
            border: 1px solid #4CAF50;
            background: white;
            color: #4CAF50;
            border-radius: 4px;
            cursor: pointer;
        }

        .nav-btn.active {
            background: #4CAF50;
            color: white;
        }

        /* ===== MAIN LAYOUT ===== */
        .main-layout {
            flex: 1;
            display: flex;
            overflow: hidden;
            padding: 20px;
            gap: 20px;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }

        /* LEFT PANEL: QUIZ NAVIGATION */
        .quiz-nav-panel {
            flex-shrink: 0;
            width: 250px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .quiz-nav-header {
            padding: 15px;
            background: #f8f9fa;
            color: #333;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .quiz-nav-grid {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            align-content: start;
        }

        .quiz-nav-btn {
            aspect-ratio: 1;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        .quiz-nav-btn.answered { background: #4CAF50; color: white; border-color: #4CAF50; }
        .quiz-nav-btn.current { border: 2px solid #FF9800; }

        .quiz-nav-legend { padding: 10px; border-top: 1px solid #eee; font-size: 11px; }
        .legend-item { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
        .legend-box { width: 12px; height: 12px; border: 1px solid #ddd; border-radius: 2px; }

        /* RIGHT PANEL: QUESTIONS AREA */
        .questions-wrapper {
            flex: 1;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            overflow-y: auto;
            padding: 30px;
            scroll-behavior: smooth;
        }

        .question-item {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4CAF50;
            scroll-margin-top: 20px;
        }

        .question-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .audio-player {
            flex: 1;
            max-width: 400px;
        }

        .audio-player audio {
            width: 100%;
            height: 40px;
            border-radius: 20px;
        }

        .question-text { 
            font-weight: 600; 
            margin-bottom: 15px; 
            font-size: 18px; 
            color: #2c3e50; 
        }

        .options-grid {
            display: flex;
            gap: 40px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .option-item {
            position: relative;
            cursor: pointer;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            width: 250px;
        }

        .option-item:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .option-item.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .option-item.correct {
            border-color: #4CAF50;
            background: #c8e6c9;
        }

        .option-item.incorrect {
            border-color: #f44336;
            background: #ffcdd2;
        }

        .option-image {
            width: 120%;
            max-height: 160px;
            object-fit: contain;
            background: #fafafa;
            padding: 5px;
            border-radius: 4px;
            margin-bottom: 0px;
        }

        .option-checkbox {
            width: 20px;
            height: 20px;
            border: 3px solid #666;
            background: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .option-item.selected .option-checkbox {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .option-item.selected .option-checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .tapescript-section {
            margin-top: 15px;
            padding: 15px;
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            display: none;
            border-radius: 4px;
        }
        .tapescript-section.show { display: block; }

        /* BOTTOM BAR */
        .bottom-bar {
            flex-shrink: 0;
            background: white;
            padding: 10px 10px;
            display: flex;
            justify-content: center;
            gap: 15px;
            border-top: 1px solid #ddd;
        }

        .btn { 
            padding: 10px 25px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            color: white; 
            transition: 0.2s; 
        }
        .submit-btn { background: #4CAF50; }
        .submit-btn:hover { background: #45a049; }
        .retry-btn { background: #FF9800; display: none; }
        .top-btn { background: #2196F3; }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal.show { display: flex; }
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            text-align: center; 
            max-width: 400px; 
            width: 90%; 
        }

        @media (max-width: 768px) {
            .header { grid-template-columns: 1fr auto; }
            .header h1 { grid-column: 1; text-align: left; font-size: 16px; }
            .main-layout { flex-direction: column; }
            .quiz-nav-panel { width: 100%; height: 180px; }
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="header">
            <div></div>
            <h1>üéß Section 1: Listen and choose the best answer</h1>
            <div class="font-controls">
                <button onclick="changeFontSize(1)">A+</button>
                <button onclick="changeFontSize(-1)">A‚àí</button>
            </div>
        </div>
        <div class="navigation" id="navigation" style="display: none;"></div>
    </div>

    <div class="main-layout">
        <div class="quiz-nav-panel">
            <div class="quiz-nav-header">Quiz navigation</div>
            <div class="quiz-nav-grid" id="quizNavGrid"></div>
            <div class="quiz-nav-legend">
                <div class="legend-item"><div class="legend-box"></div> Ch∆∞a tr·∫£ l·ªùi</div>
                <div class="legend-item"><div class="legend-box" style="background: #4CAF50;"></div> ƒê√£ tr·∫£ l·ªùi</div>
                <div class="legend-item"><div class="legend-box" style="border: 2px solid #FF9800;"></div> ƒêang xem</div>
            </div>
        </div>

        <div class="questions-wrapper" id="scrollArea">
            <div id="loading" style="text-align:center; padding: 20px;">ƒêang t·∫£i d·ªØ li·ªáu c√¢u h·ªèi...</div>
            <div id="error" style="display:none; color:red; padding: 20px; text-align: center;"></div>
            <div id="sectionsContainer"></div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn submit-btn" id="submitBtn">N·ªôp b√†i</button>
        <button class="btn retry-btn" id="retryBtn">L√†m l·∫°i</button>
        <button class="btn top-btn" onclick="scrollToTop()">V·ªÅ ƒë·∫ßu trang</button>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <div id="resultEmoji" style="font-size: 50px;">üéâ</div>
            <h2 id="resultMessage">K·∫øt qu·∫£</h2>
            <div id="resultScore" style="font-size: 40px; color: #4CAF50; font-weight: bold; margin: 10px 0;">0/0</div>
            <p id="resultPercentage">T·ª∑ l·ªá ch√≠nh x√°c: 0%</p>
            <button class="btn submit-btn" style="margin-top: 20px; width: 100%;" onclick="closeModal()">Xem audioscript</button>
        </div>
    </div>

    <script>
        let allSections = [];
        let currentSectionIndex = 0;
        let userAnswers = {};
        let fontSize = 18;
        let isSubmitted = false;

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        async function loadQuestions() {
            try {
                const response = await fetch('listening-s1-questions.json');
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i file c√¢u h·ªèi (JSON).');
                allSections = await response.json();
                document.getElementById('loading').style.display = 'none';
                renderNavigation();
                renderSection(0);
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = error.message;
            }
        }

        function renderNavigation() {
            if (allSections.length <= 1) return;
            const navDiv = document.getElementById('navigation');
            navDiv.style.display = 'flex';
            navDiv.innerHTML = allSections.map((_, idx) => `
                <button class="nav-btn ${idx === 0 ? 'active' : ''}" onclick="switchSection(${idx})">Test ${idx + 1}</button>
            `).join('');
        }

        function switchSection(index) {
            currentSectionIndex = index;
            isSubmitted = false;
            renderSection(index);
            document.querySelectorAll('.nav-btn').forEach((btn, idx) => btn.classList.toggle('active', idx === index));
        }

        function renderSection(index) {
            const section = allSections[index];
            userAnswers = {};
            const container = document.getElementById('sectionsContainer');
            const navGrid = document.getElementById('quizNavGrid');
            navGrid.innerHTML = '';
            
            container.innerHTML = section.questions.map((q, qIdx) => {
                const optionsWithIndices = q.images.map((img, oIdx) => ({ image: img, originalIndex: oIdx }));
                const shuffledOptions = shuffleArray(optionsWithIndices);

                const navBtn = document.createElement('button');
                navBtn.className = 'quiz-nav-btn';
                navBtn.id = `nav-btn-${qIdx}`;
                navBtn.textContent = qIdx + 1;
                navBtn.onclick = () => scrollToQuestion(qIdx);
                navGrid.appendChild(navBtn);

                return `
                    <div class="question-item" id="q-item-${qIdx}">
                        <div class="question-header">
                            <div class="audio-player">
                                <audio controls preload="metadata">
                                    <source src="${q.audio}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                            </div>
                        </div>
                        <div class="question-text" style="font-size: ${fontSize}px">${qIdx + 1}. ${q.question}</div>
                        <div class="options-grid">
                            ${shuffledOptions.map((opt, displayIdx) => `
                                <div class="option-item" id="option-${index}-${qIdx}-${opt.originalIndex}"
                                     onclick="handleAnswer(${qIdx}, ${opt.originalIndex})">
                                    <img src="${opt.image}" alt="Option ${displayIdx + 1}" class="option-image">
                                    <div class="option-checkbox"></div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="tapescript-section" id="tapescript-${qIdx}">
                            <strong>üìù Audioscript:</strong> ${q.tapescript || 'Ch∆∞a c√≥ audioscript.'}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('retryBtn').style.display = 'none';
            updateNavStatus();
        }

        function handleAnswer(qIdx, optionIdx) {
            if (isSubmitted) return;
            userAnswers[qIdx] = optionIdx;
            
            const section = allSections[currentSectionIndex];
            section.questions[qIdx].images.forEach((_, idx) => {
                const el = document.getElementById(`option-${currentSectionIndex}-${qIdx}-${idx}`);
                if (el) el.classList.toggle('selected', idx === optionIdx);
            });
            updateNavStatus();
        }

        function updateNavStatus() {
            allSections[currentSectionIndex].questions.forEach((_, qIdx) => {
                const btn = document.getElementById(`nav-btn-${qIdx}`);
                if (btn) btn.classList.toggle('answered', userAnswers[qIdx] !== undefined);
            });
        }

        function scrollToQuestion(qIdx) {
            const el = document.getElementById(`q-item-${qIdx}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth' });
                document.querySelectorAll('.quiz-nav-btn').forEach(b => b.classList.remove('current'));
                document.getElementById(`nav-btn-${qIdx}`).classList.add('current');
            }
        }

        document.getElementById('submitBtn').addEventListener('click', () => {
            const section = allSections[currentSectionIndex];
            const answeredCount = Object.keys(userAnswers).length;

            if (answeredCount < section.questions.length) {
                if (!confirm(`B·∫°n m·ªõi tr·∫£ l·ªùi ${answeredCount}/${section.questions.length} c√¢u. V·∫´n mu·ªën n·ªôp b√†i?`)) return;
            }

            isSubmitted = true;
            let score = 0;
            section.questions.forEach((q, qIdx) => {
                const userAns = userAnswers[qIdx];
                const isCorrect = userAns === q.answer;
                if (isCorrect) score++;

                q.images.forEach((_, oIdx) => {
                    const el = document.getElementById(`option-${currentSectionIndex}-${qIdx}-${oIdx}`);
                    if (!el) return;
                    el.style.cursor = 'not-allowed';
                    el.onclick = null;
                    if (oIdx === q.answer) el.classList.add('correct');
                    else if (oIdx === userAns) el.classList.add('incorrect');
                });
                document.getElementById(`tapescript-${qIdx}`).classList.add('show');
            });

            const percent = Math.round((score / section.questions.length) * 100);
            document.getElementById('resultScore').textContent = `${score}/${section.questions.length}`;
            document.getElementById('resultPercentage').textContent = `T·ª∑ l·ªá ch√≠nh x√°c: ${percent}%`;
            document.getElementById('resultModal').classList.add('show');
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('retryBtn').style.display = 'inline-block';
        });

        function closeModal() { document.getElementById('resultModal').classList.remove('show'); }
        function scrollToTop() { document.getElementById('scrollArea').scrollTo({ top: 0, behavior: 'smooth' }); }
        
        document.getElementById('retryBtn').addEventListener('click', () => {
            isSubmitted = false;
            renderSection(currentSectionIndex);
            scrollToTop();
        });

        function changeFontSize(delta) {
            fontSize += delta;
            document.querySelectorAll('.question-text').forEach(el => el.style.fontSize = fontSize + 'px');
        }

        document.getElementById('scrollArea').addEventListener('scroll', () => {
            const items = document.querySelectorAll('.question-item');
            items.forEach((item, idx) => {
                const rect = item.getBoundingClientRect();
                if (rect.top >= 0 && rect.top <= 300) {
                    document.querySelectorAll('.quiz-nav-btn').forEach(b => b.classList.remove('current'));
                    const navBtn = document.getElementById(`nav-btn-${idx}`);
                    if (navBtn) navBtn.classList.add('current');
                }
            });
        });

        window.addEventListener('load', loadQuestions);
    </script>
</body>
</html>