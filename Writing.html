<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing Test - Sentence Rewriting</title>

    <!-- Common Styles -->
    <link rel="stylesheet" href="styles-common.css">

    <style>
        /* Writing Test Specific Styles */
        .nav-btn.active {
            background: #9c27b0;
            color: white;
            border-color: #9c27b0;
        }

        .button-container {
            padding: 10px 10px 6px 10px;
        }

        /* ===== QUESTIONS ===== */
        .question {
            margin-bottom: 25px;
            padding: 18px;
            background: #fafafa;
            border-radius: 8px;
            border-left: 4px solid #9c27b0;
            transition: all 0.3s;
        }

        .question.correct-answer {
            border-left-color: #4caf50;
            background: #f1f8f4;
        }

        .question.incorrect-answer {
            border-left-color: #f44336;
            background: #fef5f5;
        }

        .question-text {
            font-size: 18px;
        }

        .question-number {
            font-weight: bold;
            color: #9c27b0;
            margin-right: 4px;
        }

        .starter-word {
            font-weight: bold;
            color: #2196F3;
            margin: 8px 0;
            font-size: 18px;
        }

        .dots {
            color: #999;
            letter-spacing: 1px;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
        }

        .answer-input:focus {
            outline: none;
            border-color: #9c27b0;
        }

        .answer-input.correct {
            border-color: #4caf50;
            background: #f1f8f4;
        }

        .answer-input.incorrect {
            border-color: #f44336;
            background: #fef5f5;
        }

        .answer-feedback {
            margin-top: 10px;
            display: none;
        }

        .user-answer-display {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            color: #1565c0;
            font-weight: 500;
        }

        .suggested-answer {
            padding: 10px;
            border-radius: 5px;
            font-style: italic;
            margin-bottom: 5px;
        }

        .suggested-answer.correct {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }

        .suggested-answer.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .submit-btn {
            background: #9c27b0;
        }

        .submit-btn:hover {
            background: #7b1fa2;
        }

        .result-icon {
            display: inline-block;
            margin-left: 10px;
            font-size: 20px;
        }
    </style>
</head>

<body>

<!-- ===== TOP BAR ===== -->
<div class="top-bar">
    <div class="header">
        <h1>‚úçÔ∏è Writing Test: Rewrite the sentences</h1>
        <div class="font-controls">
            <button>A+</button>
            <button>A‚àí</button>
        </div>
    </div>
    <div id="navigation" class="navigation"></div>
</div>

<!-- ===== CONTENT ===== -->
<div class="container">
    <div id="loading" class="loading">ƒêang t·∫£i ƒë·ªÅ...</div>
    <div id="sectionsContainer"></div>
</div>

<!-- ===== BOTTOM BAR ===== -->
<div class="button-container">
    <button id="submitBtn" class="submit-btn">Ch·∫•m ƒëi·ªÉm</button>
    <button id="retryBtn" class="retry-btn">L√†m l·∫°i</button>
    <button class="top-btn">V·ªÅ ƒë·∫ßu trang</button>
</div>

<!-- Result Popup Modal -->
<div id="resultModal" class="modal">
    <div class="modal-content">
        <div class="emoji" id="resultEmoji">üéâ</div>
        <div class="message" id="resultMessage">Xu·∫•t s·∫Øc!</div>
        <div class="score" id="resultScore">0/0</div>
        <div class="percentage" id="resultPercentage">ƒêi·ªÉm s·ªë: 0%</div>
        <button class="modal-close-btn" id="modalCloseBtn">ƒê√≥ng</button>
    </div>
</div>

<!-- Load Modules -->
<script src="state-manager.js"></script>
<script src="json-loader.js"></script>
<script src="modal-manager.js"></script>
<script src="font-controller.js"></script>
<script src="scroll-controller.js"></script>
<script src="navigation.js"></script>
<script src="retry-handler.js"></script>
<script src="score-calculator.js"></script>

<script>
    // Writing Test Specific Controller
    const WritingController = {
        DOTS_LENGTH: 50,

        async init() {
            StateManager.init();
            ModalManager.init();
            FontController.init({
                fontSize: 18,
                optionFontSize: 18,
                explanationFontSize: 16
            });
            ScrollController.setupScrollButton();
            this.setupEventHandlers();
            await this.loadQuestions();
        },

        setupEventHandlers() {
            RetryHandler.setupRetryButton(() => this.handleRetry());
            
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.addEventListener('click', () => this.handleSubmit());
            }

            // Font size controls
            const fontBtns = document.querySelectorAll('.font-controls button');
            if (fontBtns[0]) fontBtns[0].addEventListener('click', () => this.changeFontSize(1));
            if (fontBtns[1]) fontBtns[1].addEventListener('click', () => this.changeFontSize(-1));
        },

        async loadQuestions() {
            try {
                JSONLoader.showLoading();
                const sections = await JSONLoader.loadQuestions('writing-questions.json');
                StateManager.setSections(sections);
                JSONLoader.hideLoading();
                Navigation.renderNavigation(sections, (index) => this.switchSection(index));
                this.renderSection(0);
            } catch (error) {
                JSONLoader.hideLoading();
                JSONLoader.showError(error, 'writing-questions.json');
            }
        },

        switchSection(index) {
            StateManager.setCurrentSectionIndex(index);
            Navigation.updateActiveButton(index);
            this.renderSection(index);
            ScrollController.scrollToTop();
        },

        getEndingPunctuation(sentence) {
            const trimmed = sentence.trim();
            const lastChar = trimmed[trimmed.length - 1];
            
            if (['.', '?', '!', ',', ';', ':'].includes(lastChar)) {
                return lastChar;
            }
            return '.';
        },

        normalizeText(text) {
            return text.trim().toLowerCase()
                .replace(/\s+/g, ' ')
                .replace(/['']/g, "'")
                .replace(/[""]/g, '"')
                .replace(/[.!,;:]+$/, '');
        },

        checkAnswer(userAnswer, starterWord, suggestedAnswer) {
            const normalizedUser = this.normalizeText(userAnswer);
            const normalizedStarter = this.normalizeText(starterWord);
            const normalizedSuggested = this.normalizeText(suggestedAnswer);
            
            if (normalizedUser === normalizedSuggested) {
                return true;
            }
            
            if (normalizedSuggested.startsWith(normalizedStarter)) {
                const completion = normalizedSuggested.substring(normalizedStarter.length).trim();
                if (normalizedUser === completion) {
                    return true;
                }
            }
            
            return false;
        },

        renderSection(index) {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = '';
            container.style.display = 'block';

            const section = StateManager.allSections[index];

            section.questions.forEach((q, qIdx) => {
                const starterWord = q.incompleteSentence.split(/\.{3,}/)[0].trim();
                const endPunctuation = this.getEndingPunctuation(q.originalSentence);
                const dots = '.'.repeat(this.DOTS_LENGTH);

                const div = document.createElement('div');
                div.className = 'question';
                div.setAttribute('data-starter', starterWord);

                div.innerHTML = `
                    <div class="question-text">
                        <span class="question-number">${qIdx + 1}.</span>
                        ${q.originalSentence}
                    </div>

                    <div class="starter-word">
                        ${starterWord}<span class="dots">${dots}</span>${endPunctuation}
                    </div>

                    <input type="text" class="answer-input" data-question-index="${qIdx}">

                    <div class="answer-feedback">
                        <div class="user-answer-display">
                            C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n: <span class="user-answer-text"></span>
                        </div>
                        ${q.suggestedAnswer && q.suggestedAnswer.length > 0 
                            ? q.suggestedAnswer.map((ans, idx) => 
                                `<div class="suggested-answer" data-answer="${ans}">
                                    ƒê√°p √°n g·ª£i √Ω ${q.suggestedAnswer.length > 1 ? (idx + 1) + ': ' : ': '}${ans}
                                </div>`
                              ).join('')
                            : '<div class="suggested-answer">ƒê√°p √°n g·ª£i √Ω: ‚Äî</div>'
                        }
                    </div>
                `;

                container.appendChild(div);
            });

            RetryHandler.showSubmitButton();
            RetryHandler.hideRetryButton();
            FontController.applyFontSize();
        },

        handleSubmit() {
            const inputs = document.querySelectorAll('.answer-input');
            let allAnswered = true;

            inputs.forEach(input => {
                if (input.value.trim() === '') {
                    allAnswered = false;
                }
            });

            if (!allAnswered) {
                alert('Vui l√≤ng ho√†n th√†nh t·∫•t c·∫£ c√°c c√¢u tr∆∞·ªõc khi ch·∫•m ƒëi·ªÉm.');
                return;
            }

            let correctCount = 0;
            let totalQuestions = inputs.length;

            inputs.forEach((input, index) => {
                input.disabled = true;
                
                const userAnswer = input.value.trim();
                const questionDiv = input.parentElement;
                const starterWord = questionDiv.getAttribute('data-starter');
                const feedback = questionDiv.querySelector('.answer-feedback');
                const suggestedAnswers = feedback.querySelectorAll('.suggested-answer');
                const userAnswerDisplay = feedback.querySelector('.user-answer-text');
                
                userAnswerDisplay.textContent = userAnswer;
                
                let hasMatch = false;
                
                suggestedAnswers.forEach(suggestedDiv => {
                    const correctAnswer = suggestedDiv.getAttribute('data-answer');
                    if (correctAnswer && correctAnswer !== '‚Äî') {
                        if (this.checkAnswer(userAnswer, starterWord, correctAnswer)) {
                            hasMatch = true;
                            suggestedDiv.classList.add('correct');
                        } else {
                            suggestedDiv.classList.add('incorrect');
                        }
                    }
                });

                if (hasMatch) {
                    correctCount++;
                    input.classList.add('correct');
                    questionDiv.classList.add('correct-answer');
                    questionDiv.querySelector('.question-number').innerHTML += ' <span class="result-icon">‚úì</span>';
                } else {
                    input.classList.add('incorrect');
                    questionDiv.classList.add('incorrect-answer');
                    questionDiv.querySelector('.question-number').innerHTML += ' <span class="result-icon">‚úó</span>';
                }
            });

            document.querySelectorAll('.answer-feedback').forEach(fb => {
                fb.style.display = 'block';
            });

            ScoreCalculator.displayResult(correctCount, totalQuestions);
            RetryHandler.hideSubmitButton();
            RetryHandler.showRetryButton();
        },

        handleRetry() {
            document.querySelectorAll('.answer-input').forEach(input => {
                input.value = '';
                input.disabled = false;
                input.classList.remove('correct', 'incorrect');
            });

            document.querySelectorAll('.answer-feedback').forEach(fb => {
                fb.style.display = 'none';
            });

            document.querySelectorAll('.suggested-answer').forEach(div => {
                div.classList.remove('correct', 'incorrect');
            });

            document.querySelectorAll('.question').forEach(q => {
                q.classList.remove('correct-answer', 'incorrect-answer');
                const icon = q.querySelector('.result-icon');
                if (icon) icon.remove();
            });

            RetryHandler.showSubmitButton();
            RetryHandler.hideRetryButton();
            ScrollController.scrollToTop();
        },

        changeFontSize(delta) {
            FontController.changeFontSize(delta);
            document.querySelectorAll('.question-text, .starter-word').forEach(e => {
                e.style.fontSize = FontController.fontSize + 'px';
            });
            document.querySelectorAll('.answer-input').forEach(e => {
                e.style.fontSize = (FontController.fontSize - 2) + 'px';
            });
        }
    };

    window.addEventListener('load', () => WritingController.init());
</script>

</body>
</html>